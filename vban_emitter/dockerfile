ARG BUILD_FROM
FROM ${BUILD_FROM}

ENV DEBIAN_FRONTEND=noninteractive

# Install dependencies for building vban_emitter
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        build-essential \
        libasound2-dev \
        git \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Copy the vban source from the addon directory into the container
COPY . /tmp/vban

# Build and install vban_emitter
WORKDIR /tmp/vban
RUN ./autogen.sh \
    && ./configure --prefix=/usr --enable-alsa --disable-pulseaudio --disable-jack \
    && make \
    && make install

# Clean up build directory
RUN rm -rf /tmp/vban

# Copy and set permissions for run script
COPY run.sh /run.sh
RUN chmod +x /run.sh

# Set working directory to root
WORKDIR /

# Expose VBAN UDP port (optional, as config.json maps it)
EXPOSE 6980/udp

# Run the emitter
CMD ["/run.sh"]